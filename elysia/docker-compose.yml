include:
  - '../docker-compose.yml'

x-service-templates:
  api: &api
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - TARGET=api/index.ts
    env_file:
      - .env
    depends_on:
      - valkey
      - haproxy
    networks:
      - payment-processor
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 50M

  worker: &worker
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - TARGET=worker/index.ts
    env_file:
      - .env
    depends_on:
      - payment-processor-1
      - payment-processor-2
      - valkey
    networks:
      - payment-processor
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 50M

services:
  haproxy:
    image: haproxy:2.9
    container_name: haproxy
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "9999:80"
    networks:
      - payment-processor
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 50M

  api-1:
    <<: *api
    container_name: api-1

  api-2:
    <<: *api
    container_name: api-2

  worker-1:
    <<: *worker
    container_name: worker-1

  worker-2:
    <<: *worker
    container_name: worker-2

  valkey:
    image: valkey/valkey:latest
    container_name: valkey
    command: valkey-server --appendonly yes
    hostname: valkey
    networks:
      - payment-processor
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 30M