x-service-templates:
  api: &api
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - TARGET=api/index.ts
    env_file:
      - .env
    depends_on:
      - valkey

  worker: &worker
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - TARGET=worker/index.ts
    env_file:
      - .env
    depends_on:
      - valkey

services:
  haproxy:
    image: haproxy:2.9
    container_name: haproxy
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "9999:80"

  api-1:
    <<: *api
    container_name: api-1

  api-2:
    <<: *api
    container_name: api-2

  worker-1:
    <<: *worker
    container_name: worker-1

  worker-2:
    <<: *worker
    container_name: worker-2

  valkey:
    image: valkey/valkey:latest
    container_name: valkey
    command: valkey-server --appendonly yes
    hostname: valkey
